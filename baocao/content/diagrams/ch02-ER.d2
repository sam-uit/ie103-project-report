# Template: D2
# Author: Sam Dinh
# Mục đích: Tạo ER Diagram Chen Notation.
# Trang nguồn: https://d2lang.com/
# VSCode extension: Terrastruct.d2

direction: right

# Tiêu đề: căn góc trên-giữa
# title: |md
#   # Mô Hình Thực Thể Quan Hệ (ER Diagram Chen Notation)
# | {near: top-center}

# title.style: {
# font-size: 20
# font: "mono"
# }

# --- 0. STYLES ---
style: {
  # font: "mono"
  opacity: 0.0
  # fill: "#dcdcdc"
  # stroke: "orange"
  # stroke-width: 5
}

# --- 1. CSS STYLES (THEME) ---
classes: {
  # Thực thể: Chữ nhật bo góc Apple style
  entity: {
    shape: rectangle
    style: {
      border-radius: 15
      stroke-width: 2
      fill: "#FFFFFF"
      stroke: "#333333"
    }
  }

  # Quan hệ (Relationship): Hình thoi
  rel: {
    shape: diamond
    style: {
      fill: "#F2F2F7"
      stroke: "#8E8E93"
      stroke-width: 2
    }
  }

  # Thuộc tính: Oval
  attr: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#0d95de"
      stroke-width: 1
      # font-size: 20
    }
  }

  # Khóa chính: gạch chân
  # viền xanh
  attr_pri: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#0d95de"
      stroke-width: 1
      # font-size: 20
      underline: true
    }
  }

  # Khóa chính là khóa khóa ngoại từ bảng khác
  # gạch chân
  # viền cam
  attr_foreign_pri: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#f2840e"
      stroke-width: 1
      # font-size: 20
      underline: true
    }
  }

  # Khóa ngoại từ bảng khác
  # gạch chân
  # viền cam
  attr_foreign_key: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#f2840e"
      stroke-width: 1
      # font-size: 20
      # underline: true
    }
  }
}

# --- 2. ENTITIES (THỰC THỂ) ---
# Dựa trên init_tables.sql và tài liệu mô tả

# MARK: ADMINS
ADMINS: {class: entity; label: "ADMINS"}
admin_id: {class: attr_pri; label: "id"}
admin_email: {class: attr; label: "email"}
admin_password: {class: attr; label: "password"}
admin_full_name: {class: attr; label: "full_name"}
admin_status: {class: attr; label: "status"}
admin_created_at: {class: attr; label: "created_at"}
admin_updated_at: {class: attr; label: "updated_at"}
ADMINS -- admin_id: {style: {stroke-width: 1}}
ADMINS -- admin_email: {style: {stroke-width: 1}}
ADMINS -- admin_password: {style: {stroke-width: 1}}
ADMINS -- admin_full_name: {style: {stroke-width: 1}}
ADMINS -- admin_status: {style: {stroke-width: 1}}
ADMINS -- admin_created_at: {style: {stroke-width: 1}}
ADMINS -- admin_updated_at: {style: {stroke-width: 1}}

# MARK: ROLES
ROLES: {class: entity; label: "ROLES"}
roles_id: {class: attr_pri; label: "id"}
roles_code: {class: attr; label: "code"}
roles_name: {class: attr; label: "name"}
roles_description: {class: attr; label: "description"}

ROLES -- roles_id: {style: {stroke-width: 1}}
ROLES -- roles_code: {style: {stroke-width: 1}}
ROLES -- roles_name: {style: {stroke-width: 1}}
ROLES -- roles_description: {style: {stroke-width: 1}}


PERMISSIONS: {class: entity; label: "PERMISSIONS"}
permission_id: {class: attr_pri; label: "id"}
PERMISSIONS -- permission_id: {style: {stroke-width: 1}}

USERS: {class: entity; label: "USERS"}
user_id: {class: attr_pri; label: "id"}
USERS -- user_id: {style: {stroke-width: 1}}

VOUCHERS: {class: entity; label: "VOUCHERS"}
voucher_id: {class: attr_pri; label: "id"}
VOUCHERS -- voucher_id: {style: {stroke-width: 1}}

DATPHONG: {class: entity; label: "DATPHONG"}
datphong_id: {class: attr_pri; label: "id"}
DATPHONG -- datphong_id: {style: {stroke-width: 1}}

LOAIPHONG: {class: entity; label: "LOAIPHONG"}
loaiphong_id: {class: attr_pri; label: "id"}
LOAIPHONG -- loaiphong_id: {style: {stroke-width: 1}}

PHONG: {class: entity; label: "PHONG"}
phong_id: {class: attr_pri; label: "id"}
PHONG -- phong_id: {style: {stroke-width: 1}}

DICHVU: {class: entity; label: "DICHVU"}
dichvu_id: {class: attr_pri; label: "id"}
DICHVU -- dichvu_id: {style: {stroke-width: 1}}

PAYMENTS: {class: entity; label: "PAYMENTS"}
payment_id: {class: attr_pri; label: "id"}
PAYMENTS -- payment_id: {style: {stroke-width: 1}}

REFUNDS: {class: entity; label: "REFUNDS"}
refund_id: {class: attr_pri; label: "id"}
REFUNDS -- refund_id: {style: {stroke-width: 1}}

REVIEWS: {class: entity; label: "REVIEWS"}
review_id: {class: attr_pri; label: "id"}
REVIEWS -- review_id: {style: {stroke-width: 1}}

# --- 3. RELATIONSHIPS (MỐI QUAN HỆ) ---
# Phân biệt rõ đâu là quan hệ. 
# Các bảng trung gian N-N trong SQL được coi là Quan Hệ trong ERD.
# FOREIGN KEY: orange

# Quan hệ N-N (Từ bảng trung gian)
ADMIN_ROLES: {class: rel; label: "Được Gán\nADMIN_ROLES"}
admin_roles_pri_key: {class: attr_foreign_pri; width: 200; label: "admin_id, role_id"}
ADMIN_ROLES -- admin_roles_pri_key: {style: {stroke-width: 1; stroke: orange}}

ROLE_PERMISSIONS: {class: rel; label: "Bao Gồm\nROLE_PERMISSIONS"}
roles_permissions_pri_key: {class: attr_foreign_pri; width: 200; label: "role_id, permission_id"}
ROLE_PERMISSIONS -- roles_permissions_pri_key: {style: {stroke-width: 1; stroke: orange}}

CT_DATPHONG: {class: rel; label: "Chi Tiết Đặt\nCT_DATPHONG"}
ct_datphong_id: {class: attr_pri; label: "id"}
ct_datphong_phong_id: {class: attr_foreign_pri; label: "phong_id"}
ct_datphong_datphong_id: {class: attr_foreign_pri; label: "datphong_id"; width: 120}
ct_datphong_dongia: {class: attr_pri; label: "don_gia"}

CT_DATPHONG -- ct_datphong_id: {style: {stroke-width: 1}}
CT_DATPHONG -- ct_datphong_dongia: {style: {stroke-width: 1}}
CT_DATPHONG -- ct_datphong_phong_id: {style: {stroke-width: 1; stroke: orange}}
CT_DATPHONG -- ct_datphong_datphong_id: {style: {stroke-width: 1; stroke: orange}}

# MARK: CT_SUDUNG_DV

CT_SUDUNG_DV: {class: rel; label: "Chi Tiết DV\nCT_SUDUNG_DV"}
ct_sudung_dv_id: {class: attr_pri; label: "id"}
ct_sudung_dv_datphong_id: {class: attr_foreign_key; label: "datphong_id"; width: 120}
ct_sudung_dv_dongia: {class: attr; label: "don_gia"}
ct_sudung_dv_dichvu_id: {class: attr_foreign_key; label: "dichvu_id"; width: 120}

CT_SUDUNG_DV -- ct_sudung_dv_id: {style: {stroke-width: 1}}
CT_SUDUNG_DV -- ct_sudung_dv_dongia: {style: {stroke-width: 1}}
CT_SUDUNG_DV -- ct_sudung_dv_datphong_id: {style: {stroke-width: 1; stroke: orange}}
CT_SUDUNG_DV -- ct_sudung_dv_dichvu_id: {style: {stroke-width: 1; stroke: orange}}

# Quan hệ 1-N / 1-1 (Logical)
thuc_hien: {class: rel; label: "Thực Hiện"}
thuoc_loai: {class: rel; label: "Thuộc Loại"}
ap_dung: {class: rel; label: "Áp Dụng"}
thanh_toan: {class: rel; label: "Thanh Toán"}
hoan_tien: {class: rel; label: "Hoàn Tiền"}
yeu_cau: {class: rel; label: "Yêu Cầu"}
duoc_duyet: {class: rel; label: "Được Duyệt"}
tao_review: {class: rel; label: "Viết"}
review_cho: {class: rel; label: "Review Cho"}
review_cua: {class: rel; label: "Của Đơn"}

# --- 4. CONNECTIONS (CARDINALITY) ---

# --- Nhóm User & Authorization ---
# N-N: Admin - Roles
ADMINS -- ADMIN_ROLES: m
ADMIN_ROLES -- ROLES: n

# N-N: Roles - Permissions
ROLES -- ROLE_PERMISSIONS: m
ROLE_PERMISSIONS -- PERMISSIONS: n

# --- Nhóm Booking & Room ---
# 1-N: User - DatPhong
USERS -- thuc_hien: 1
thuc_hien -- DATPHONG: n

# N-N: DatPhong - Phong (thông qua CT_DATPHONG)
DATPHONG -- CT_DATPHONG: m
CT_DATPHONG -- PHONG: n

# 1-N: LoaiPhong - Phong
PHONG -- thuoc_loai: n
thuoc_loai -- LOAIPHONG: 1

# 1-N: Voucher - DatPhong
VOUCHERS -- ap_dung: 1
ap_dung -- DATPHONG: n

# N-N: DatPhong - DichVu (thông qua CT_SUDUNG_DV)
DATPHONG -- CT_SUDUNG_DV: m
CT_SUDUNG_DV -- DICHVU: n

# --- Nhóm Payment & Refund ---
# 1-N: DatPhong - Payments (Một đơn có thể có nhiều giao dịch?)
# SQL: Payment references Booking.
DATPHONG -- thanh_toan: 1
thanh_toan -- PAYMENTS: n

# 1-N: Payments - Refunds
PAYMENTS -- hoan_tien: 1
hoan_tien -- REFUNDS: n

# User & Admin liên quan đến Refund
USERS -- yeu_cau: 1
yeu_cau -- REFUNDS: n
ADMINS -- duoc_duyet: 1
duoc_duyet -- REFUNDS: n

# --- Nhóm Review ---
# SQL: Reviews references User, Phong, DatPhong (Unique)

# 1-N: User - Reviews
USERS -- tao_review: 1
tao_review -- REVIEWS: n

# 1-N: Phong - Reviews
PHONG -- review_cho: 1
review_cho -- REVIEWS: n

# 1-1: DatPhong - Reviews (Mỗi đơn 1 review)
DATPHONG -- review_cua: 1
review_cua -- REVIEWS: 1
