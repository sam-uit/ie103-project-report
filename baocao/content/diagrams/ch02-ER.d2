# Template: D2
# Author: Sam Dinh
# Mục đích: Tạo ER Diagram Chen Notation.
# Trang nguồn: https://d2lang.com/
# VSCode extension: Terrastruct.d2

direction: right

# Tiêu đề: căn góc trên-giữa
# title: |md
#   # Mô Hình Thực Thể Quan Hệ (ER Diagram Chen Notation)
# | {near: top-center}

# title.style: {
# font-size: 20
# font: "mono"
# }

# --- 0. STYLES ---
style: {
  # font: "mono"
  opacity: 0.0
  # fill: "#dcdcdc"
  # stroke: "orange"
  # stroke-width: 5
}

# --- 1. CSS STYLES (THEME) ---
classes: {
  # Thực thể: Chữ nhật bo góc Apple style
  entity: {
    shape: rectangle
    style: {
      border-radius: 15
      stroke-width: 2
      fill: "#FFFFFF"
      stroke: "#333333"
    }
  }

  # Quan hệ (Relationship): Hình thoi
  rel: {
    shape: diamond
    style: {
      fill: "#F2F2F7"
      stroke: "#8E8E93"
      stroke-width: 2
    }
  }

  # Thuộc tính: Oval
  attr: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#0d95de"
      stroke-width: 1
      # font-size: 20
    }
  }

  # Khóa chính: gạch chân
  # viền xanh
  attr_pri: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#0d95de"
      stroke-width: 1
      # font-size: 20
      underline: true
    }
  }

  # Khóa chính là khóa khóa ngoại từ bảng khác
  # gạch chân
  # viền cam
  attr_foreign_pri: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#f2840e"
      stroke-width: 1
      # font-size: 20
      underline: true
    }
  }

  # Khóa ngoại từ bảng khác
  # gạch chân
  # viền cam
  attr_foreign_key: {
    shape: oval
    width: 90
    height: 40
    style: {
      fill: "#F0F8FF"
      stroke: "#f2840e"
      stroke-width: 1
      # font-size: 20
      # underline: true
    }
  }
}

# --- 2. ENTITIES (THỰC THỂ) ---
# Dựa trên init_tables.sql và tài liệu mô tả

# MARK: ADMINS
ADMINS: {class: entity; label: "ADMINS"}
admin_id: {class: attr_pri; label: "id"}
admin_email: {class: attr; label: "email"}
admin_password: {class: attr; label: "password"}
admin_full_name: {class: attr; label: "full_name"}
admin_status: {class: attr; label: "status"}
admin_created_at: {class: attr; label: "created_at"; width: 110}
admin_updated_at: {class: attr; label: "updated_at"; width: 110}
ADMINS -- admin_id: {style: {stroke-width: 1}}
ADMINS -- admin_email: {style: {stroke-width: 1}}
ADMINS -- admin_password: {style: {stroke-width: 1}}
ADMINS -- admin_full_name: {style: {stroke-width: 1}}
ADMINS -- admin_status: {style: {stroke-width: 1}}
ADMINS -- admin_created_at: {style: {stroke-width: 1}}
ADMINS -- admin_updated_at: {style: {stroke-width: 1}}

# MARK: ROLES
ROLES: {class: entity; label: "ROLES"}
roles_id: {class: attr_pri; label: "id"}
roles_code: {class: attr; label: "code"}
roles_name: {class: attr; label: "name"}
roles_description: {class: attr; label: "description"}

ROLES -- roles_id: {style: {stroke-width: 1}}
ROLES -- roles_code: {style: {stroke-width: 1}}
ROLES -- roles_name: {style: {stroke-width: 1}}
ROLES -- roles_description: {style: {stroke-width: 1}}

# MARK: PERMISSIONS
PERMISSIONS: {class: entity; label: "PERMISSIONS"}
permissions_id: {class: attr_pri; label: "id"}
permissions_code: {class: attr; label: "code"}
permissions_description: {class: attr; label: "description"}
PERMISSIONS -- permissions_id: {style: {stroke-width: 1}}
PERMISSIONS -- permissions_code: {style: {stroke-width: 1}}
PERMISSIONS -- permissions_description: {style: {stroke-width: 1}}

# MARK: USERS
USERS: {class: entity; label: "USERS"}
users_id: {class: attr_pri; label: "id"}
users_email: {class: attr; label: "email"}
users_phone: {class: attr; label: "phone"}
users_password_hash: {class: attr; label: "password_hash"; width: 140}
users_full_name: {class: attr; label: "full_name"}
users_status: {class: attr; label: "status"}
users_created_at: {class: attr; label: "created_at"; width: 110}
users_updated_at: {class: attr; label: "updated_at"; width: 110}

USERS -- users_id: {style: {stroke-width: 1}}
USERS -- users_email: {style: {stroke-width: 1}}
USERS -- users_password_hash: {style: {stroke-width: 1}}
USERS -- users_full_name: {style: {stroke-width: 1}}
USERS -- users_phone: {style: {stroke-width: 1}}
USERS -- users_status: {style: {stroke-width: 1}}
USERS -- users_created_at: {style: {stroke-width: 1}}
USERS -- users_updated_at: {style: {stroke-width: 1}}

# MARK: VOUCHERS
VOUCHERS: {class: entity; label: "VOUCHERS"}
vouchers_id: {class: attr_pri; label: "id"}
vouchers_ma_code: {class: attr; label: "ma_code"}
vouchers_phan_tram_giam: {class: attr; label: "phan_tram_giam"; width: 150}
vouchers_ngay_het_han: {class: attr; label: "ngay_het_han"; width: 150}
vouchers_so_tien_toi_thieu: {class: attr; label: "so_tien_toi_thieu"; width: 160}
vouchers_so_lan_toi_da: {class: attr; label: "so_lan_toi_da"; width: 150}
vouchers_so_lan_da_dung: {class: attr; label: "so_lan_da_dung"; width: 150}
vouchers_trang_thai: {class: attr; label: "trang_thai"}
vouchers_created_at: {class: attr; label: "created_at"; width: 110}
vouchers_updated_at: {class: attr; label: "updated_at"; width: 110}

VOUCHERS -- vouchers_id: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_ma_code: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_phan_tram_giam: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_ngay_het_han: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_so_tien_toi_thieu: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_so_lan_toi_da: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_so_lan_da_dung: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_trang_thai: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_created_at: {style: {stroke-width: 1}}
VOUCHERS -- vouchers_updated_at: {style: {stroke-width: 1}}

# MARK: DATPHONG
DATPHONG: {class: entity; label: "DATPHONG"}
datphong_id: {class: attr_pri; label: "id"}
datphong_user_id: {class: attr; label: "user_id"}
datphong_voucher_id: {class: attr; label: "voucher_id"}
datphong_check_in: {class: attr; label: "check_in"}
datphong_check_out: {class: attr; label: "check_out"}
datphong_trang_thai: {class: attr; label: "trang_thai"}
datphong_created_at: {class: attr; label: "created_at"; width: 110}

DATPHONG -- datphong_id: {style: {stroke-width: 1}}
DATPHONG -- datphong_user_id: {style: {stroke-width: 1}}
DATPHONG -- datphong_voucher_id: {style: {stroke-width: 1}}
DATPHONG -- datphong_check_in: {style: {stroke-width: 1}}
DATPHONG -- datphong_check_out: {style: {stroke-width: 1}}
DATPHONG -- datphong_trang_thai: {style: {stroke-width: 1}}
DATPHONG -- datphong_created_at: {style: {stroke-width: 1}}

# MARK: LOAIPHONG
LOAIPHONG: {class: entity; label: "LOAIPHONG"}
loaiphong_id: {class: attr_pri; label: "id"}
loaiphong_ten_loai: {class: attr; label: "ten_loai"}
loaiphong_gia_co_ban: {class: attr; label: "gia_co_ban"; width: 110}
loaiphong_mo_ta: {class: attr; label: "mo_ta"}
loaiphong_suc_chua: {class: attr; label: "suc_chua"}

LOAIPHONG -- loaiphong_id: {style: {stroke-width: 1}}
LOAIPHONG -- loaiphong_ten_loai: {style: {stroke-width: 1}}
LOAIPHONG -- loaiphong_gia_co_ban: {style: {stroke-width: 1}}
LOAIPHONG -- loaiphong_mo_ta: {style: {stroke-width: 1}}
LOAIPHONG -- loaiphong_suc_chua: {style: {stroke-width: 1}}

# MARK: PHONG
PHONG: {class: entity; label: "PHONG"}
phong_id: {class: attr_pri; label: "id"}
phong_so_phong: {class: attr; label: "so_phong"}
phong_loai_phong_id: {class: attr_foreign_key; label: "loai_phong_id"; width: 120}
phong_trang_thai: {class: attr; label: "trang_thai"}

PHONG -- phong_id: {style: {stroke-width: 1}}
PHONG -- phong_so_phong: {style: {stroke-width: 1}}
PHONG -- phong_loai_phong_id: {style: {stroke-width: 1}}
PHONG -- phong_trang_thai: {style: {stroke-width: 1}}

# MARK: DICHVU
DICHVU: {class: entity; label: "DICHVU"}
dichvu_id: {class: attr_pri; label: "id"}
dichvu_ten_dich_vu: {class: attr; label: "ten_dich_vu"; width: 120}
dichvu_don_gia: {class: attr; label: "don_gia"}
dichvu_don_vi_tinh: {class: attr; label: "don_vi_tinh"; width: 120}
dichvu_trang_thai: {class: attr; label: "trang_thai"}
dichvu_created_at: {class: attr; label: "created_at"; width: 110}
dichvu_updated_at: {class: attr; label: "updated_at"; width: 110}

DICHVU -- dichvu_id: {style: {stroke-width: 1}}
DICHVU -- dichvu_ten_dich_vu: {style: {stroke-width: 1}}
DICHVU -- dichvu_don_gia: {style: {stroke-width: 1}}
DICHVU -- dichvu_don_vi_tinh: {style: {stroke-width: 1}}
DICHVU -- dichvu_trang_thai: {style: {stroke-width: 1}}
DICHVU -- dichvu_created_at: {style: {stroke-width: 1}}
DICHVU -- dichvu_updated_at: {style: {stroke-width: 1}}

# MARK: PAYMENTS
PAYMENTS: {class: entity; label: "PAYMENTS"}
payments_id: {class: attr_pri; label: "id"}
payments_booking_id: {class: attr_foreign_key; label: "booking_id"}
payments_user_id: {class: attr_foreign_key; label: "user_id"}
payments_so_tien: {class: attr; label: "so_tien"}
payments_phuong_thuc: {class: attr; label: "phuong_thuc"; width: 120}
payments_trang_thai: {class: attr; label: "trang_thai"}
payments_created_at: {class: attr; label: "created_at"; width: 110}

PAYMENTS -- payments_id: {style: {stroke-width: 1}}
PAYMENTS -- payments_booking_id: {style: {stroke-width: 1}}
PAYMENTS -- payments_user_id: {style: {stroke-width: 1}}
PAYMENTS -- payments_so_tien: {style: {stroke-width: 1}}
PAYMENTS -- payments_phuong_thuc: {style: {stroke-width: 1}}
PAYMENTS -- payments_trang_thai: {style: {stroke-width: 1}}
PAYMENTS -- payments_created_at: {style: {stroke-width: 1}}

# MARK: REFUNDS
REFUNDS: {class: entity; label: "REFUNDS"}
refunds_id: {class: attr_pri; label: "id"}
refunds_payment_id: {class: attr_foreign_key; label: "payment_id"; width: 120}
refunds_so_tien_hoan: {class: attr; label: "so_tien_hoan"; width: 120}
refunds_trang_thai: {class: attr; label: "trang_thai"}
refunds_ly_do: {class: attr; label: "ly_do"}
refunds_requested_by: {class: attr_foreign_key; label: "requested_by"; width: 120}
refunds_approved_by: {class: attr_foreign_key; label: "approved_by"; width: 120}
refunds_created_at: {class: attr; label: "created_at"; width: 110}
refunds_updated_at: {class: attr; label: "updated_at"; width: 110}

REFUNDS -- refunds_id: {style: {stroke-width: 1}}
REFUNDS -- refunds_payment_id: {style: {stroke-width: 1}}
REFUNDS -- refunds_so_tien_hoan: {style: {stroke-width: 1}}
REFUNDS -- refunds_trang_thai: {style: {stroke-width: 1}}
REFUNDS -- refunds_ly_do: {style: {stroke-width: 1}}
REFUNDS -- refunds_requested_by: {style: {stroke-width: 1}}
REFUNDS -- refunds_approved_by: {style: {stroke-width: 1}}
REFUNDS -- refunds_created_at: {style: {stroke-width: 1}}
REFUNDS -- refunds_updated_at: {style: {stroke-width: 1}}

# MARK: REVIEWS
REVIEWS: {class: entity; label: "REVIEWS"}
reviews_id: {class: attr_pri; label: "id"}
reviews_user_id: {class: attr_foreign_key; label: "user_id"; width: 120}
reviews_phong_id: {class: attr_foreign_key; label: "phong_id"; width: 120}
reviews_datphong_id: {class: attr_foreign_key; label: "datphong_id"; width: 120}
reviews_so_sao: {class: attr; label: "so_sao"}
reviews_binh_luan: {class: attr; label: "binh_luan"; width: 110}
reviews_ngay_danh_gia: {class: attr; label: "ngay_danh_gia"; width: 120}
reviews_trang_thai: {class: attr; label: "trang_thai"; width: 110}
reviews_created_at: {class: attr; label: "created_at"; width: 110}
reviews_updated_at: {class: attr; label: "updated_at"; width: 110}

REVIEWS -- reviews_id: {style: {stroke-width: 1}}
REVIEWS -- reviews_user_id: {style: {stroke-width: 1}}
REVIEWS -- reviews_phong_id: {style: {stroke-width: 1}}
REVIEWS -- reviews_datphong_id: {style: {stroke-width: 1}}
REVIEWS -- reviews_so_sao: {style: {stroke-width: 1}}
REVIEWS -- reviews_binh_luan: {style: {stroke-width: 1}}
REVIEWS -- reviews_ngay_danh_gia: {style: {stroke-width: 1}}
REVIEWS -- reviews_trang_thai: {style: {stroke-width: 1}}
REVIEWS -- reviews_created_at: {style: {stroke-width: 1}}
REVIEWS -- reviews_updated_at: {style: {stroke-width: 1}}

# --- 3. RELATIONSHIPS (MỐI QUAN HỆ) ---
# Phân biệt rõ đâu là quan hệ. 
# Các bảng trung gian N-N trong SQL được coi là Quan Hệ trong ERD.
# FOREIGN KEY: orange

# Quan hệ N-N (Từ bảng trung gian)
ADMIN_ROLES: {class: rel; label: "Được Gán\nADMIN_ROLES"}
admin_roles_pri_key: {class: attr_foreign_pri; width: 200; label: "admin_id, role_id"}
ADMIN_ROLES -- admin_roles_pri_key: {style: {stroke-width: 1; stroke: orange}}

ROLE_PERMISSIONS: {class: rel; label: "Bao Gồm\nROLE_PERMISSIONS"}
roles_permissions_pri_key: {class: attr_foreign_pri; width: 200; label: "role_id, permission_id"}
ROLE_PERMISSIONS -- roles_permissions_pri_key: {style: {stroke-width: 1; stroke: orange}}

CT_DATPHONG: {class: rel; label: "Chi Tiết Đặt\nCT_DATPHONG"}
ct_datphong_id: {class: attr_pri; label: "id"}
ct_datphong_phong_id: {class: attr_foreign_pri; label: "phong_id"}
ct_datphong_datphong_id: {class: attr_foreign_pri; label: "datphong_id"; width: 120}
ct_datphong_dongia: {class: attr_pri; label: "don_gia"}

CT_DATPHONG -- ct_datphong_id: {style: {stroke-width: 1}}
CT_DATPHONG -- ct_datphong_dongia: {style: {stroke-width: 1}}
CT_DATPHONG -- ct_datphong_phong_id: {style: {stroke-width: 1; stroke: orange}}
CT_DATPHONG -- ct_datphong_datphong_id: {style: {stroke-width: 1; stroke: orange}}

# MARK: CT_SUDUNG_DV
CT_SUDUNG_DV: {class: rel; label: "Chi Tiết DV\nCT_SUDUNG_DV"}
ct_sudung_dv_id: {class: attr_pri; label: "id"}
ct_sudung_dv_datphong_id: {class: attr_foreign_key; label: "datphong_id"; width: 120}
ct_sudung_dv_dichvu_id: {class: attr_foreign_key; label: "dichvu_id"; width: 120}
ct_sudung_dv_so_luong: {class: attr; label: "so_luong"}
ct_sudung_dv_don_gia: {class: attr; label: "don_gia"}
ct_sudung_dv_thoi_diem_su_dung: {class: attr; label: "thoi_diem_su_dung"; width: 150}
ct_sudung_dv_ghi_chu: {class: attr; label: "ghi_chu"}
ct_sudung_dv_created_at: {class: attr; label: "created_at"; width: 110}

CT_SUDUNG_DV -- ct_sudung_dv_id: {style: {stroke-width: 1}}
CT_SUDUNG_DV -- ct_sudung_dv_datphong_id: {style: {stroke-width: 1; stroke: orange}}
CT_SUDUNG_DV -- ct_sudung_dv_dichvu_id: {style: {stroke-width: 1; stroke: orange}}
CT_SUDUNG_DV -- ct_sudung_dv_so_luong: {style: {stroke-width: 1}}
CT_SUDUNG_DV -- ct_sudung_dv_don_gia: {style: {stroke-width: 1}}
CT_SUDUNG_DV -- ct_sudung_dv_thoi_diem_su_dung: {style: {stroke-width: 1}}
CT_SUDUNG_DV -- ct_sudung_dv_ghi_chu: {style: {stroke-width: 1}}
CT_SUDUNG_DV -- ct_sudung_dv_created_at: {style: {stroke-width: 1}}

# Quan hệ 1-N / 1-1 (Logical)
thuc_hien: {class: rel; label: "Thực Hiện"}
thuoc_loai: {class: rel; label: "Thuộc Loại"}
ap_dung: {class: rel; label: "Áp Dụng"}
thanh_toan: {class: rel; label: "Thanh Toán"}
hoan_tien: {class: rel; label: "Hoàn Tiền"}
yeu_cau: {class: rel; label: "Yêu Cầu"}
duoc_duyet: {class: rel; label: "Được Duyệt"}
tao_review: {class: rel; label: "Viết"}
review_cho: {class: rel; label: "Review Cho"}
review_cua: {class: rel; label: "Của Đơn"}

# --- 4. CONNECTIONS (CARDINALITY) ---

# --- Nhóm User & Authorization ---
# N-N: Admin - Roles
ADMINS -- ADMIN_ROLES: m
ADMIN_ROLES -- ROLES: n

# N-N: Roles - Permissions
ROLES -- ROLE_PERMISSIONS: m
ROLE_PERMISSIONS -- PERMISSIONS: n

# --- Nhóm Booking & Room ---
# 1-N: User - DatPhong
USERS -- thuc_hien: 1
thuc_hien -- DATPHONG: n

# N-N: DatPhong - Phong (thông qua CT_DATPHONG)
DATPHONG -- CT_DATPHONG: m
CT_DATPHONG -- PHONG: n

# 1-N: LoaiPhong - Phong
PHONG -- thuoc_loai: n
thuoc_loai -- LOAIPHONG: 1

# 1-N: Voucher - DatPhong
VOUCHERS -- ap_dung: 1
ap_dung -- DATPHONG: n

# N-N: DatPhong - DichVu (thông qua CT_SUDUNG_DV)
DATPHONG -- CT_SUDUNG_DV: m
CT_SUDUNG_DV -- DICHVU: n

# --- Nhóm Payment & Refund ---
# 1-N: DatPhong - Payments (Một đơn có thể có nhiều giao dịch?)
# SQL: Payment references Booking.
DATPHONG -- thanh_toan: 1
thanh_toan -- PAYMENTS: n

# 1-N: Payments - Refunds
PAYMENTS -- hoan_tien: 1
hoan_tien -- REFUNDS: n

# User & Admin liên quan đến Refund
USERS -- yeu_cau: 1
yeu_cau -- REFUNDS: n
ADMINS -- duoc_duyet: 1
duoc_duyet -- REFUNDS: n

# --- Nhóm Review ---
# SQL: Reviews references User, Phong, DatPhong (Unique)

# 1-N: User - Reviews
USERS -- tao_review: 1
tao_review -- REVIEWS: n

# 1-N: Phong - Reviews
PHONG -- review_cho: 1
review_cho -- REVIEWS: n

# 1-1: DatPhong - Reviews (Mỗi đơn 1 review)
DATPHONG -- review_cua: 1
review_cua -- REVIEWS: 1
