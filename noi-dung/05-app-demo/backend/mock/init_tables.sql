-- ============================================
-- INIT DATABASE FOR ROOM BOOKING SYSTEM (MSSQL)
-- Phiên bản đầy đủ với CHECK constraints
-- ============================================

-- DROP TABLES IF EXIST (Order matters due to FK)
DROP TABLE IF EXISTS REVIEWS;
DROP TABLE IF EXISTS CT_SUDUNG_DV;
DROP TABLE IF EXISTS DICHVU;
DROP TABLE IF EXISTS REFUNDS;
DROP TABLE IF EXISTS PAYMENTS;
DROP TABLE IF EXISTS CT_DATPHONG;
DROP TABLE IF EXISTS DATPHONG;
DROP TABLE IF EXISTS VOUCHERS;
DROP TABLE IF EXISTS PHONG;
DROP TABLE IF EXISTS LOAIPHONG;
DROP TABLE IF EXISTS ROLE_PERMISSIONS;
DROP TABLE IF EXISTS ADMIN_ROLES;
DROP TABLE IF EXISTS PERMISSIONS;
DROP TABLE IF EXISTS ROLES;
DROP TABLE IF EXISTS ADMINS;
DROP TABLE IF EXISTS USERS;
GO

-- ===== NGƯỜI DÙNG & PHÂN QUYỀN =====

CREATE TABLE ADMINS (
    id INT IDENTITY PRIMARY KEY,
    email NVARCHAR(255) NOT NULL UNIQUE,
    password_hash NVARCHAR(255) NOT NULL,
    full_name NVARCHAR(255),
    status NVARCHAR(50) DEFAULT 'ACTIVE',
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    CONSTRAINT CK_ADMINS_STATUS CHECK (status IN ('ACTIVE', 'INACTIVE'))
);

CREATE TABLE ROLES (
    id INT IDENTITY PRIMARY KEY,
    code NVARCHAR(50) NOT NULL UNIQUE,
    name NVARCHAR(255) NOT NULL,
    description NVARCHAR(500)
);

CREATE TABLE PERMISSIONS (
    id INT IDENTITY PRIMARY KEY,
    code NVARCHAR(100) NOT NULL UNIQUE,
    description NVARCHAR(255)
);

CREATE TABLE ADMIN_ROLES (
    admin_id INT NOT NULL,
    role_id INT NOT NULL,
    PRIMARY KEY (admin_id, role_id),
    FOREIGN KEY (admin_id) REFERENCES ADMINS(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES ROLES(id) ON DELETE CASCADE
);

CREATE TABLE ROLE_PERMISSIONS (
    role_id INT NOT NULL,
    permission_id INT NOT NULL,
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES ROLES(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES PERMISSIONS(id) ON DELETE CASCADE
);

CREATE TABLE USERS (
    id INT IDENTITY PRIMARY KEY,
    email NVARCHAR(255) NOT NULL UNIQUE,
    phone NVARCHAR(20),
    password_hash NVARCHAR(255) NOT NULL,
    full_name NVARCHAR(255),
    status NVARCHAR(50) DEFAULT 'ACTIVE',
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    CONSTRAINT CK_USERS_STATUS CHECK (status IN ('ACTIVE', 'INACTIVE'))
);

-- ===== PHÒNG & ĐẶT PHÒNG =====

CREATE TABLE LOAIPHONG (
    id INT IDENTITY PRIMARY KEY,
    ten_loai NVARCHAR(100) NOT NULL,
    gia_co_ban DECIMAL(18,2) NOT NULL,
    mo_ta NVARCHAR(500),
    suc_chua INT DEFAULT 2,
    CONSTRAINT CK_LOAIPHONG_GIA_CO_BAN CHECK (gia_co_ban > 0),
    CONSTRAINT CK_LOAIPHONG_SUC_CHUA CHECK (suc_chua > 0)
);

CREATE TABLE PHONG (
    id INT IDENTITY PRIMARY KEY,
    so_phong NVARCHAR(20) NOT NULL UNIQUE,
    loai_phong_id INT NOT NULL,
    trang_thai NVARCHAR(50) DEFAULT 'AVAILABLE',
    FOREIGN KEY (loai_phong_id) REFERENCES LOAIPHONG(id),
    CONSTRAINT CK_PHONG_TRANG_THAI CHECK (trang_thai IN ('AVAILABLE', 'OCCUPIED', 'MAINTENANCE', 'RESERVED'))
);

-- ===== MÃ GIẢM GIÁ (VOUCHERS) =====

CREATE TABLE VOUCHERS (
    id INT IDENTITY PRIMARY KEY,
    ma_code NVARCHAR(50) NOT NULL UNIQUE,
    phan_tram_giam DECIMAL(5,2) NOT NULL,
    ngay_het_han DATE NOT NULL,
    so_tien_toi_thieu DECIMAL(18,2) DEFAULT 0,
    so_lan_toi_da INT DEFAULT 100,
    so_lan_da_dung INT DEFAULT 0,
    trang_thai NVARCHAR(50) DEFAULT 'ACTIVE',
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    CONSTRAINT CK_VOUCHERS_PHAN_TRAM_GIAM CHECK (phan_tram_giam >= 0 AND phan_tram_giam <= 100),
    CONSTRAINT CK_VOUCHERS_SO_TIEN_TOI_THIEU CHECK (so_tien_toi_thieu >= 0),
    CONSTRAINT CK_VOUCHERS_SO_LAN_TOI_DA CHECK (so_lan_toi_da > 0),
    CONSTRAINT CK_VOUCHERS_SO_LAN_DA_DUNG CHECK (so_lan_da_dung >= 0),
    CONSTRAINT CK_VOUCHERS_SO_LAN_DUNG CHECK (so_lan_da_dung <= so_lan_toi_da),
    CONSTRAINT CK_VOUCHERS_TRANG_THAI CHECK (trang_thai IN ('ACTIVE', 'INACTIVE'))
);

CREATE TABLE DATPHONG (
    id INT IDENTITY PRIMARY KEY,
    user_id INT NOT NULL,
    voucher_id INT NULL,
    check_in DATETIME NOT NULL,
    check_out DATETIME NOT NULL,
    trang_thai NVARCHAR(50) DEFAULT 'PENDING',
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (user_id) REFERENCES USERS(id),
    FOREIGN KEY (voucher_id) REFERENCES VOUCHERS(id),
    CONSTRAINT CK_DATPHONG_CHECK_OUT_AFTER_CHECK_IN CHECK (check_out > check_in),
    CONSTRAINT CK_DATPHONG_CHECK_IN_TIME CHECK (CAST(check_in AS TIME) >= '14:00:00'),
    CONSTRAINT CK_DATPHONG_CHECK_OUT_TIME CHECK (CAST(check_out AS TIME) <= '12:00:00'),
    CONSTRAINT CK_DATPHONG_TRANG_THAI CHECK (trang_thai IN ('PENDING', 'CONFIRMED', 'CANCELLED', 'COMPLETED'))
);

CREATE TABLE CT_DATPHONG (
    id INT IDENTITY PRIMARY KEY,
    datphong_id INT NOT NULL,
    phong_id INT NOT NULL,
    don_gia DECIMAL(18,2) NOT NULL,
    FOREIGN KEY (datphong_id) REFERENCES DATPHONG(id) ON DELETE CASCADE,
    FOREIGN KEY (phong_id) REFERENCES PHONG(id),
    CONSTRAINT UQ_CT_DATPHONG UNIQUE (datphong_id, phong_id),
    CONSTRAINT CK_CT_DATPHONG_DON_GIA CHECK (don_gia > 0)
);

-- ===== THANH TOÁN =====

CREATE TABLE PAYMENTS (
    id INT IDENTITY PRIMARY KEY,
    booking_id INT NOT NULL,
    user_id INT NOT NULL,
    so_tien DECIMAL(18,2) NOT NULL,
    phuong_thuc NVARCHAR(50),
    trang_thai NVARCHAR(50),
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (booking_id) REFERENCES DATPHONG(id),
    FOREIGN KEY (user_id) REFERENCES USERS(id),
    CONSTRAINT CK_PAYMENTS_SO_TIEN CHECK (so_tien > 0),
    CONSTRAINT CK_PAYMENTS_TRANG_THAI CHECK (trang_thai IN ('PENDING', 'SUCCESS', 'FAILED', 'CANCELLED', 'PAID', 'UNPAID', 'REFUNDED')),
    CONSTRAINT CK_PAYMENTS_PHUONG_THUC CHECK (phuong_thuc IN ('TIEN_MAT', 'CHUYEN_KHOAN', 'THE', 'ONLINE') OR phuong_thuc IS NULL)
);

CREATE TABLE REFUNDS (
    id INT IDENTITY PRIMARY KEY,
    payment_id INT NOT NULL,
    so_tien_hoan DECIMAL(18,2) NOT NULL,
    trang_thai NVARCHAR(50),
    ly_do NVARCHAR(500),
    requested_by INT NOT NULL,
    approved_by INT,
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (payment_id) REFERENCES PAYMENTS(id),
    FOREIGN KEY (requested_by) REFERENCES USERS(id),
    FOREIGN KEY (approved_by) REFERENCES ADMINS(id),
    CONSTRAINT CK_REFUNDS_SO_TIEN_HOAN CHECK (so_tien_hoan > 0),
    CONSTRAINT CK_REFUNDS_TRANG_THAI CHECK (trang_thai IN ('REQUESTED', 'APPROVED', 'REJECTED', 'COMPLETED'))
);

-- ===== DỊCH VỤ =====

CREATE TABLE DICHVU (
    id INT IDENTITY PRIMARY KEY,
    ten_dich_vu NVARCHAR(255) NOT NULL,
    don_gia DECIMAL(18,2) NOT NULL,
    don_vi_tinh NVARCHAR(50) DEFAULT N'Lần',
    trang_thai NVARCHAR(50) DEFAULT 'ACTIVE',
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    CONSTRAINT CK_DICHVU_DON_GIA CHECK (don_gia > 0),
    CONSTRAINT CK_DICHVU_TRANG_THAI CHECK (trang_thai IN ('ACTIVE', 'INACTIVE'))
);

CREATE TABLE CT_SUDUNG_DV (
    id INT IDENTITY PRIMARY KEY,
    datphong_id INT NOT NULL,
    dichvu_id INT NOT NULL,
    so_luong INT NOT NULL DEFAULT 1,
    don_gia DECIMAL(18,2) NOT NULL,
    thoi_diem_su_dung DATETIME DEFAULT GETDATE(),
    ghi_chu NVARCHAR(500),
    created_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (datphong_id) REFERENCES DATPHONG(id) ON DELETE CASCADE,
    FOREIGN KEY (dichvu_id) REFERENCES DICHVU(id),
    CONSTRAINT CK_CT_SUDUNG_DV_SO_LUONG CHECK (so_luong > 0),
    CONSTRAINT CK_CT_SUDUNG_DV_DON_GIA CHECK (don_gia > 0)
);

-- ===== ĐÁNH GIÁ =====

CREATE TABLE REVIEWS (
    id INT IDENTITY PRIMARY KEY,
    user_id INT NOT NULL,
    phong_id INT NOT NULL,
    datphong_id INT NOT NULL UNIQUE,
    so_sao INT NOT NULL,
    binh_luan NVARCHAR(1000),
    ngay_danh_gia DATE DEFAULT CAST(GETDATE() AS DATE),
    trang_thai NVARCHAR(50) DEFAULT 'PENDING',
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (user_id) REFERENCES USERS(id),
    FOREIGN KEY (phong_id) REFERENCES PHONG(id),
    FOREIGN KEY (datphong_id) REFERENCES DATPHONG(id),
    CONSTRAINT CK_REVIEWS_SO_SAO CHECK (so_sao >= 1 AND so_sao <= 5),
    CONSTRAINT CK_REVIEWS_TRANG_THAI CHECK (trang_thai IN ('PENDING', 'APPROVED', 'REJECTED'))
);

GO
