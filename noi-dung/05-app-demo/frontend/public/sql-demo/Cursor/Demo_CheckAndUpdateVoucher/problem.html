<!DOCTYPE html>
<html lang="vi">

<head>
      <meta charset="UTF-8">
      <style>
            body {
                  font-family: 'Inter', -apple-system, sans-serif;
                  line-height: 1.7;
                  color: #1e293b;
                  background: #fff;
                  margin: 0;
                  padding: 0;
            }

            h1 {
                  font-size: 1.875rem;
                  font-weight: 700;
                  color: #7c3aed;
                  margin: 0 0 1.5rem 0;
                  padding-bottom: 0.75rem;
                  border-bottom: 2px solid #8b5cf6;
            }

            h2 {
                  font-size: 1.5rem;
                  font-weight: 600;
                  color: #0f172a;
                  margin: 2rem 0 1rem 0;
            }

            h3 {
                  font-size: 1.125rem;
                  font-weight: 600;
                  color: #334155;
                  margin: 1.5rem 0 0.75rem 0;
            }

            p {
                  margin: 0.75rem 0;
                  color: #475569;
            }

            ul {
                  margin: 0.75rem 0;
                  padding-left: 1.5rem;
            }

            li {
                  margin: 0.375rem 0;
                  color: #475569;
            }

            strong {
                  color: #0f172a;
                  font-weight: 600;
            }

            table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 1.25rem 0;
                  font-size: 0.9375rem;
                  background: #fff;
                  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                  border-radius: 0.5rem;
                  overflow: hidden;
            }

            th {
                  background-color: #c4b5fd;
                  padding: 0.875rem 1rem;
                  text-align: left;
                  font-weight: 600;
                  color: #4c1d95;
                  border-bottom: 2px solid #a78bfa;
            }

            td {
                  padding: 0.75rem 1rem;
                  color: #334155;
                  border-bottom: 1px solid #e2e8f0;
            }

            tbody tr:hover {
                  background-color: #f5f3ff;
            }

            code {
                  font-family: 'Fira Code', monospace;
                  font-size: 0.875rem;
                  background-color: #f5f3ff;
                  color: #7c3aed;
                  padding: 0.125rem 0.375rem;
                  border-radius: 0.25rem;
            }

            pre {
                  background-color: #1e293b;
                  color: #e2e8f0;
                  padding: 1.25rem;
                  border-radius: 0.5rem;
                  overflow-x: auto;
                  margin: 1.25rem 0;
            }

            pre code {
                  background: none;
                  color: inherit;
                  padding: 0;
            }

            .flow-step {
                  background-color: #f5f3ff;
                  border-left: 3px solid #8b5cf6;
                  padding: 0.875rem 1rem;
                  margin: 0.5rem 0;
                  border-radius: 0.25rem;
                  color: #334155;
            }

            hr {
                  border: none;
                  border-top: 1px solid #e2e8f0;
                  margin: 2rem 0;
            }
      </style>
</head>

<body>
      <h1>üéüÔ∏è CURSOR ‚Äì Ki·ªÉm Tra & C·∫≠p Nh·∫≠t Voucher</h1>

      <h2>CS_CHECK_UPDATE_VOUCHER ‚Äì Batch update voucher status</h2>

      <div class="section">
            <h3>üìå M·ª•c ƒë√≠ch</h3>
            <p>Cursor ƒë·ªÉ <strong>ki·ªÉm tra v√† c·∫≠p nh·∫≠t h√†ng lo·∫°t</strong> tr·∫°ng th√°i voucher:</p>
            <ul>
                  <li>Duy·ªát qua t·∫•t c·∫£ voucher</li>
                  <li>Ki·ªÉm tra ng√†y h·∫øt h·∫°n</li>
                  <li>Ki·ªÉm tra s·ªë l·∫ßn s·ª≠ d·ª•ng</li>
                  <li>C·∫≠p nh·∫≠t tr·∫°ng th√°i EXPIRED/EXHAUSTED</li>
            </ul>
      </div>

      <hr>

      <div class="section">
            <h3>üéØ Khi n√†o ch·∫°y</h3>
            <table>
                  <thead>
                        <tr>
                              <th>Lo·∫°i</th>
                              <th>T·∫ßn su·∫•t</th>
                              <th>Trigger</th>
                        </tr>
                  </thead>
                  <tbody>
                        <tr>
                              <td>Scheduled Job</td>
                              <td>Daily (00:00)</td>
                              <td>SQL Agent Job</td>
                        </tr>
                        <tr>
                              <td>Manual</td>
                              <td>On-demand</td>
                              <td>Admin trigger</td>
                        </tr>
                  </tbody>
            </table>
      </div>

      <hr>

      <div class="section">
            <h3>üîÑ Logic x·ª≠ l√Ω</h3>
            <div class="flow-step">1. DECLARE CURSOR cho SELECT * FROM VOUCHER WHERE trang_thai = 'ACTIVE'</div>
            <div class="flow-step">2. OPEN cursor v√† FETCH NEXT</div>
            <div class="flow-step">3. WHILE @@FETCH_STATUS = 0:</div>
            <div class="flow-step" style="margin-left: 2rem;">a. Ki·ªÉm tra <code>ngay_het_han &lt; GETDATE()</code> ‚Üí
                  EXPIRED</div>
            <div class="flow-step" style="margin-left: 2rem;">b. Ki·ªÉm tra <code>so_lan_su_dung &gt;= gioi_han</code> ‚Üí
                  EXHAUSTED</div>
            <div class="flow-step" style="margin-left: 2rem;">c. UPDATE tr·∫°ng th√°i n·∫øu c·∫ßn</div>
            <div class="flow-step">4. CLOSE v√† DEALLOCATE cursor</div>
      </div>

      <hr>

      <div class="section">
            <h3>üìä Tr·∫°ng th√°i voucher</h3>
            <table>
                  <thead>
                        <tr>
                              <th>Tr·∫°ng th√°i</th>
                              <th>ƒêi·ªÅu ki·ªán</th>
                              <th>C√≥ th·ªÉ s·ª≠ d·ª•ng</th>
                        </tr>
                  </thead>
                  <tbody>
                        <tr>
                              <td>ACTIVE</td>
                              <td>C√≤n hi·ªáu l·ª±c, c√≤n l∆∞·ª£t</td>
                              <td>‚úì C√≥</td>
                        </tr>
                        <tr>
                              <td>EXPIRED</td>
                              <td>Qu√° ng√†y h·∫øt h·∫°n</td>
                              <td>‚úó Kh√¥ng</td>
                        </tr>
                        <tr>
                              <td>EXHAUSTED</td>
                              <td>H·∫øt l∆∞·ª£t s·ª≠ d·ª•ng</td>
                              <td>‚úó Kh√¥ng</td>
                        </tr>
                  </tbody>
            </table>
      </div>

      <hr>

      <div class="section">
            <h3>‚úÖ K·∫øt qu·∫£ demo</h3>
            <pre><code>-- Tr∆∞·ªõc khi ch·∫°y cursor
SELECT code, trang_thai, ngay_het_han, so_lan_su_dung, gioi_han 
FROM VOUCHER;
-- SUMMER2024  ACTIVE   2024-01-15  10  10
-- WINTER2025  ACTIVE   2025-02-28  5   20

-- Ch·∫°y cursor
EXEC CS_CHECK_UPDATE_VOUCHER;

-- Sau khi ch·∫°y
SELECT code, trang_thai FROM VOUCHER;
-- SUMMER2024  EXHAUSTED  (ƒë√£ h·∫øt l∆∞·ª£t)
-- WINTER2025  ACTIVE     (v·∫´n c√≤n)</code></pre>
      </div>
</body>

</html>