<!DOCTYPE html>
<html lang="vi">

<head>
      <meta charset="UTF-8">
      <style>
            body {
                  font-family: 'Inter', -apple-system, sans-serif;
                  line-height: 1.7;
                  color: #1e293b;
                  background: #fff;
                  margin: 0;
                  padding: 0;
            }

            h1 {
                  font-size: 1.875rem;
                  font-weight: 700;
                  color: #7c3aed;
                  margin: 0 0 1.5rem 0;
                  padding-bottom: 0.75rem;
                  border-bottom: 2px solid #8b5cf6;
            }

            h2 {
                  font-size: 1.5rem;
                  font-weight: 600;
                  color: #0f172a;
                  margin: 2rem 0 1rem 0;
            }

            h3 {
                  font-size: 1.125rem;
                  font-weight: 600;
                  color: #334155;
                  margin: 1.5rem 0 0.75rem 0;
            }

            p {
                  margin: 0.75rem 0;
                  color: #475569;
            }

            ul {
                  margin: 0.75rem 0;
                  padding-left: 1.5rem;
            }

            li {
                  margin: 0.375rem 0;
                  color: #475569;
            }

            strong {
                  color: #0f172a;
                  font-weight: 600;
            }

            table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 1.25rem 0;
                  font-size: 0.9375rem;
                  background: #fff;
                  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                  border-radius: 0.5rem;
                  overflow: hidden;
            }

            th {
                  background-color: #c4b5fd;
                  padding: 0.875rem 1rem;
                  text-align: left;
                  font-weight: 600;
                  color: #4c1d95;
                  border-bottom: 2px solid #a78bfa;
            }

            td {
                  padding: 0.75rem 1rem;
                  color: #334155;
                  border-bottom: 1px solid #e2e8f0;
            }

            tbody tr:hover {
                  background-color: #f5f3ff;
            }

            code {
                  font-family: 'Fira Code', monospace;
                  font-size: 0.875rem;
                  background-color: #f5f3ff;
                  color: #7c3aed;
                  padding: 0.125rem 0.375rem;
                  border-radius: 0.25rem;
            }

            pre {
                  background-color: #1e293b;
                  color: #e2e8f0;
                  padding: 1.25rem;
                  border-radius: 0.5rem;
                  overflow-x: auto;
                  margin: 1.25rem 0;
            }

            pre code {
                  background: none;
                  color: inherit;
                  padding: 0;
            }

            .flow-step {
                  background-color: #f5f3ff;
                  border-left: 3px solid #8b5cf6;
                  padding: 0.875rem 1rem;
                  margin: 0.5rem 0;
                  border-radius: 0.25rem;
                  color: #334155;
            }

            hr {
                  border: none;
                  border-top: 1px solid #e2e8f0;
                  margin: 2rem 0;
            }
      </style>
</head>

<body>
      <h1>üè® CURSOR ‚Äì ƒê·ªìng b·ªô tr·∫°ng th√°i ph√≤ng th·ª±c t·∫ø</h1>

      <h2>cur_phong_status ‚Äì ƒê·ªìng b·ªô tr·∫°ng th√°i ph√≤ng</h2>

      <div class="section">
            <h3>üìå M·ª•c ƒë√≠ch</h3>
            <p>Th·ª±c hi·ªán nhi·ªám v·ª• <strong>ki·ªÉm k√™ (Audit) v√† b·∫£o tr√¨ d·ªØ li·ªáu</strong>. Cursor n√†y ƒë·∫£m b·∫£o tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa 
                  ph√≤ng (<code>AVAILABLE</code>, <code>OCCUPIED</code>, <code>MAINTENANCE</code>, <code>RESERVED</code>) tr√™n giao di·ªán lu√¥n kh·ªõp v·ªõi d·ªØ li·ªáu ƒë·∫∑t 
                  ph√≤ng th·ª±c t·∫ø trong c∆° s·ªü d·ªØ li·ªáu.</p>
      </div>

      <hr>

      <div class="section">
            <h3>üîÑ Logic x·ª≠ l√Ω</h3>
            <div class="flow-step">1. Duy·ªát qua t·∫•t c·∫£ c√°c ph√≤ng trong b·∫£ng PHONG, l·∫•y th√¥ng tin id, so_phong v√† trang_thai hi·ªán t·∫°i</div>
            <div class="flow-step">2. V·ªõi m·ªói ph√≤ng, th·ª±c hi·ªán truy v·∫•n ki·ªÉm tra xem c√≥ ƒë∆°n ƒë·∫∑t ph√≤ng n√†o ƒëang ho·∫°t ƒë·ªông (Tr·∫°ng th√°i CONFIRMED v√† th·ªùi gian hi·ªán t·∫°i n·∫±m trong kho·∫£ng l∆∞u tr√∫)</div>
            <div class="flow-step">3. C·∫≠p nh·∫≠t tr·∫°ng th√°i:</div>
            <div class="flow-step" style="margin-left: 2rem;">
                  <strong>Tr∆∞·ªùng h·ª£p 1 (C√≥ kh√°ch ƒëang ·ªü):</strong> N·∫øu tr·∫°ng th√°i hi·ªán t·∫°i ch∆∞a ph·∫£i OCCUPIED ‚Üí C·∫≠p nh·∫≠t th√†nh OCCUPIED
            </div>
            <div class="flow-step" style="margin-left: 2rem;">
                  <strong>Tr∆∞·ªùng h·ª£p 2 (Kh√¥ng c√≥ kh√°ch):</strong>
                  <ul style="margin-top: 0.5rem;">
                        <li>N·∫øu tr·∫°ng th√°i hi·ªán t·∫°i l√† OCCUPIED (t·ª©c l√† d·ªØ li·ªáu c≈© b·ªã sai/treo) ‚Üí Tr·∫£ v·ªÅ AVAILABLE</li>
                        <li>N·∫øu tr·∫°ng th√°i hi·ªán t·∫°i l√† MAINTENANCE (B·∫£o tr√¨) ho·∫∑c RESERVED (ƒê√£ ƒë·∫∑t tr∆∞·ªõc) ‚Üí Gi·ªØ nguy√™n, kh√¥ng can thi·ªáp</li>
                  </ul>
            </div>
      </div>

      <hr>

      <div class="section">
            <h3>üíª Source Code</h3>
            <pre><code>DECLARE @id_phong INT;
DECLARE @so_phong NVARCHAR(20);
DECLARE @trang_thai_hien_tai NVARCHAR(50); -- Th√™m bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i hi·ªán t·∫°i
DECLARE @is_occupied INT;

DECLARE cur_phong_status CURSOR FOR 
SELECT id, so_phong, trang_thai FROM PHONG; -- L·∫•y th√™m c·ªôt trang_thai

OPEN cur_phong_status;
FETCH NEXT FROM cur_phong_status INTO @id_phong, @so_phong, @trang_thai_hien_tai;

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Ki·ªÉm tra xem ph√≤ng c√≥ kh√°ch ƒëang ·ªü (CONFIRMED v√† trong th·ªùi gian l∆∞u tr√∫)
    SELECT @is_occupied = COUNT(*) 
    FROM CT_DATPHONG ct
    JOIN DATPHONG dp ON ct.datphong_id = dp.id
    WHERE ct.phong_id = @id_phong 
      AND dp.trang_thai = 'CONFIRMED'
      AND GETDATE() BETWEEN dp.check_in AND dp.check_out;

    IF @is_occupied > 0
    BEGIN
        -- N·∫øu c√≥ kh√°ch m√† tr·∫°ng th√°i ch∆∞a ph·∫£i OCCUPIED th√¨ m·ªõi c·∫≠p nh·∫≠t
        IF @trang_thai_hien_tai != 'OCCUPIED'
        BEGIN
            UPDATE PHONG SET trang_thai = 'OCCUPIED' WHERE id = @id_phong;
            PRINT N'Ph√≤ng ' + @so_phong + N': C·∫≠p nh·∫≠t sang ƒêang c√≥ kh√°ch (OCCUPIED)';
        END
    END
    ELSE
    BEGIN
        -- Logic an to√†n: Ch·ªâ chuy·ªÉn v·ªÅ AVAILABLE n·∫øu tr·∫°ng th√°i c≈© l√† OCCUPIED
        -- (Tr√°nh ghi ƒë√® tr·∫°ng th√°i MAINTENANCE ho·∫∑c RESERVED)
        IF @trang_thai_hien_tai = 'OCCUPIED'
        BEGIN
            UPDATE PHONG SET trang_thai = 'AVAILABLE' WHERE id = @id_phong;
            PRINT N'Ph√≤ng ' + @so_phong + N': Kh√°ch ƒë√£ ƒëi, tr·∫£ v·ªÅ Tr·ªëng (AVAILABLE)';
        END
        ELSE
        BEGIN
             PRINT N'Ph√≤ng ' + @so_phong + N': Gi·ªØ nguy√™n tr·∫°ng th√°i (' + @trang_thai_hien_tai + ')';
        END
    END

    FETCH NEXT FROM cur_phong_status INTO @id_phong, @so_phong, @trang_thai_hien_tai;
END

CLOSE cur_phong_status;
DEALLOCATE cur_phong_status;
GO</code></pre>
      </div>

      <hr>

      <div class="section">
            <h3>üìä Tr·∫°ng th√°i ph√≤ng</h3>
            <table>
                  <thead>
                        <tr>
                              <th>Tr·∫°ng th√°i</th>
                              <th>M√¥ t·∫£</th>
                              <th>Ghi ch√∫</th>
                        </tr>
                  </thead>
                  <tbody>
                        <tr>
                              <td><code>AVAILABLE</code></td>
                              <td>Ph√≤ng tr·ªëng, s·∫µn s√†ng ƒë√≥n kh√°ch</td>
                              <td>Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ kh√°ch</td>
                        </tr>
                        <tr>
                              <td><code>OCCUPIED</code></td>
                              <td>Ph√≤ng ƒëang c√≥ kh√°ch ·ªü</td>
                              <td>T·ª± ƒë·ªông c·∫≠p nh·∫≠t khi c√≥ ƒë∆°n ƒë·∫∑t ph√≤ng CONFIRMED</td>
                        </tr>
                        <tr>
                              <td><code>MAINTENANCE</code></td>
                              <td>Ph√≤ng ƒëang b·∫£o tr√¨</td>
                              <td>Gi·ªØ nguy√™n, kh√¥ng t·ª± ƒë·ªông thay ƒë·ªïi</td>
                        </tr>
                        <tr>
                              <td><code>RESERVED</code></td>
                              <td>Ph√≤ng ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t tr∆∞·ªõc</td>
                              <td>Gi·ªØ nguy√™n, kh√¥ng t·ª± ƒë·ªông thay ƒë·ªïi</td>
                        </tr>
                  </tbody>
            </table>
      </div>

      <hr>

      <div class="section">
            <h3>‚úÖ Ki·ªÉm th·ª≠</h3>
            <h4>K·ªãch b·∫£n:</h4>
            <ul>
                  <li><strong>Ph√≤ng 101:</strong> ƒêang tr·ªëng th·ª±c t·∫ø nh∆∞ng d·ªØ li·ªáu l·ªói hi·ªÉn th·ªã l√† <code>OCCUPIED</code></li>
                  <li><strong>Ph√≤ng 201:</strong> ƒêang c√≥ kh√°ch ·ªü th·ª±c t·∫ø nh∆∞ng hi·ªÉn th·ªã l√† <code>AVAILABLE</code></li>
                  <li><strong>Ph√≤ng 204:</strong> ƒêang b·∫£o tr√¨ (<code>MAINTENANCE</code>), kh√¥ng c√≥ kh√°ch</li>
            </ul>
            
            <h4>D·ªØ li·ªáu ban ƒë·∫ßu:</h4>
            <table>
                  <thead>
                        <tr>
                              <th>Ph√≤ng</th>
                              <th>Tr·∫°ng th√°i hi·ªán t·∫°i</th>
                              <th>Ghi ch√∫</th>
                        </tr>
                  </thead>
                  <tbody>
                        <tr>
                              <td>101</td>
                              <td><code>AVAILABLE</code></td>
                              <td>ƒê√∫ng</td>
                        </tr>
                        <tr>
                              <td>102</td>
                              <td><code>AVAILABLE</code></td>
                              <td>Sai</td>
                        </tr>
                        <tr>
                              <td>503</td>
                              <td><code>MAINTENANCE</code></td>
                              <td>ƒê√∫ng</td>
                        </tr>
                  </tbody>
            </table>

            <h4>K·∫øt qu·∫£ mong ƒë·ª£i:</h4>
            <ul>
                  <li><strong>Ph√≤ng 101</strong> ‚Üí Gi·ªØ nguy√™n l√† <code>AVAILABLE</code></li>
                  <li><strong>Ph√≤ng 102</strong> ‚Üí ƒê∆∞·ª£c s·ª≠a th√†nh <code>OCCUPIED</code></li>
                  <li><strong>Ph√≤ng 503</strong> ‚Üí Gi·ªØ nguy√™n l√† <code>MAINTENANCE</code></li>
            </ul>

            <h4>K·∫øt qu·∫£ in ra mong ƒë·ª£i:</h4>
            <pre><code>-- Ch·∫°y ƒëo·∫°n code Cursor b√™n tr√™n v√† quan s√°t c·ª≠a s·ªï Messages
-- K·∫øt qu·∫£ in ra mong ƒë·ª£i:
-- Ph√≤ng 101: Gi·ªØ nguy√™n tr·∫°ng th√°i (AVAILABLE)
-- Ph√≤ng 102: C·∫≠p nh·∫≠t sang ƒêang c√≥ kh√°ch (OCCUPIED)
-- Ph√≤ng 503: Gi·ªØ nguy√™n tr·∫°ng th√°i (MAINTENANCE)</code></pre>
      </div>
</body>

</html>