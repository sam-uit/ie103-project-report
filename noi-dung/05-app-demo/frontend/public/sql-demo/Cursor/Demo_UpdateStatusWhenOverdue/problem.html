<!DOCTYPE html>
<html lang="vi">

<head>
      <meta charset="UTF-8">
      <style>
            body {
                  font-family: 'Inter', -apple-system, sans-serif;
                  line-height: 1.7;
                  color: #1e293b;
                  background: #fff;
                  margin: 0;
                  padding: 0;
            }

            h1 {
                  font-size: 1.875rem;
                  font-weight: 700;
                  color: #7c3aed;
                  margin: 0 0 1.5rem 0;
                  padding-bottom: 0.75rem;
                  border-bottom: 2px solid #8b5cf6;
            }

            h2 {
                  font-size: 1.5rem;
                  font-weight: 600;
                  color: #0f172a;
                  margin: 2rem 0 1rem 0;
            }

            h3 {
                  font-size: 1.125rem;
                  font-weight: 600;
                  color: #334155;
                  margin: 1.5rem 0 0.75rem 0;
            }

            p {
                  margin: 0.75rem 0;
                  color: #475569;
            }

            ul {
                  margin: 0.75rem 0;
                  padding-left: 1.5rem;
            }

            li {
                  margin: 0.375rem 0;
                  color: #475569;
            }

            strong {
                  color: #0f172a;
                  font-weight: 600;
            }

            table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 1.25rem 0;
                  font-size: 0.9375rem;
                  background: #fff;
                  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                  border-radius: 0.5rem;
                  overflow: hidden;
            }

            th {
                  background-color: #c4b5fd;
                  padding: 0.875rem 1rem;
                  text-align: left;
                  font-weight: 600;
                  color: #4c1d95;
                  border-bottom: 2px solid #a78bfa;
            }

            td {
                  padding: 0.75rem 1rem;
                  color: #334155;
                  border-bottom: 1px solid #e2e8f0;
            }

            tbody tr:hover {
                  background-color: #f5f3ff;
            }

            code {
                  font-family: 'Fira Code', monospace;
                  font-size: 0.875rem;
                  background-color: #f5f3ff;
                  color: #7c3aed;
                  padding: 0.125rem 0.375rem;
                  border-radius: 0.25rem;
            }

            pre {
                  background-color: #1e293b;
                  color: #e2e8f0;
                  padding: 1.25rem;
                  border-radius: 0.5rem;
                  overflow-x: auto;
                  margin: 1.25rem 0;
            }

            pre code {
                  background: none;
                  color: inherit;
                  padding: 0;
            }

            .flow-step {
                  background-color: #f5f3ff;
                  border-left: 3px solid #8b5cf6;
                  padding: 0.875rem 1rem;
                  margin: 0.5rem 0;
                  border-radius: 0.25rem;
                  color: #334155;
            }

            hr {
                  border: none;
                  border-top: 1px solid #e2e8f0;
                  margin: 2rem 0;
            }
      </style>
</head>

<body>
      <h1>üîÑ CURSOR ‚Äì T·ª± ƒê·ªông Ho√†n T·∫•t ƒê∆°n ƒê·∫∑t Ph√≤ng</h1>

      <h2>CURSOR_CHECKOUT ‚Äì C·∫≠p nh·∫≠t tr·∫°ng th√°i khi qu√° gi·ªù check-out</h2>

      <div class="section">
            <h3>üìå M·ª•c ƒë√≠ch</h3>
            <p>T·ª± ƒë·ªông h√≥a vi·ªác k·∫øt th√∫c quy tr√¨nh ƒë·∫∑t ph√≤ng. H·ªá th·ªëng qu√©t c√°c ƒë∆°n ƒë·∫∑t ph√≤ng ƒë√£ qu√° h·∫°n tr·∫£ ph√≤ng (<code>Check-out</code>) nh∆∞ng tr·∫°ng th√°i v·∫´n l√† <code>CONFIRMED</code> ƒë·ªÉ chuy·ªÉn sang <code>COMPLETED</code> v√† gi·∫£i ph√≥ng ph√≤ng.</p>
      </div>

      <hr>

      <div class="section">
            <h3>üîÑ Logic x·ª≠ l√Ω</h3>
            <div class="flow-step">1. Khai b√°o Cursor qu√©t b·∫£ng <code>DATPHONG</code></div>
            <div class="flow-step">2. ƒêi·ªÅu ki·ªán l·ªçc: <code>trang_thai = 'CONFIRMED'</code> V√Ä <code>check_out &lt; GETDATE()</code> (Th·ªùi gian hi·ªán t·∫°i ƒë√£ v∆∞·ª£t qua gi·ªù check-out)</div>
            <div class="flow-step">3. V√≤ng l·∫∑p x·ª≠ l√Ω t·ª´ng ƒë∆°n:</div>
            <div class="flow-step" style="margin-left: 2rem;">a. C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n (<code>DATPHONG</code>) th√†nh <code>COMPLETED</code></div>
            <div class="flow-step" style="margin-left: 2rem;">b. T√¨m c√°c ph√≤ng li√™n quan trong b·∫£ng <code>CT_DATPHONG</code> v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i ph√≤ng (<code>PHONG</code>) v·ªÅ <code>AVAILABLE</code> (S·∫µn s√†ng ƒë√≥n kh√°ch m·ªõi)</div>
            <div class="flow-step" style="margin-left: 2rem;">c. ƒê·∫øm s·ªë l∆∞·ª£ng ƒë∆°n ƒë√£ x·ª≠ l√Ω v√† in log th√¥ng b√°o</div>
      </div>

      <hr>

      <div class="section">
            <h3>üíª Source Code</h3>
            <pre><code>DECLARE @id_datphong INT;
DECLARE @dem_completed INT = 0;

-- Khai b√°o Cursor cho c√°c ƒë∆°n ƒë√£ qu√° h·∫°n tr·∫£ ph√≤ng
DECLARE cursor_checkout CURSOR FOR 
SELECT id 
FROM DATPHONG 
WHERE trang_thai = 'CONFIRMED' 
  AND check_out < GETDATE();

OPEN cursor_checkout;

FETCH NEXT FROM cursor_checkout INTO @id_datphong;

WHILE @@FETCH_STATUS = 0
BEGIN
    -- C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n ƒë·∫∑t ph√≤ng
    UPDATE DATPHONG 
    SET trang_thai = 'COMPLETED' 
    WHERE id = @id_datphong;
    
    -- C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i c√°c ph√≤ng trong ƒë∆°n ƒë√≥ th√†nh 'AVAILABLE'
    UPDATE PHONG 
    SET trang_thai = 'AVAILABLE'
    WHERE id IN (SELECT phong_id FROM CT_DATPHONG WHERE datphong_id = @id_datphong);

    SET @dem_completed = @dem_completed + 1;
    PRINT N'ƒê√£ ho√†n t·∫•t ƒë∆°n ƒë·∫∑t ph√≤ng s·ªë: ' + CAST(@id_datphong AS NVARCHAR(10));

    FETCH NEXT FROM cursor_checkout INTO @id_datphong;
END

CLOSE cursor_checkout;
DEALLOCATE cursor_checkout;

PRINT N'>>> T·ªïng c·ªông ƒë√£ x·ª≠ l√Ω xong ' + CAST(@dem_completed AS NVARCHAR(10)) + N' ƒë∆°n qu√° h·∫°n.';
GO</code></pre>
      </div>

      <hr>

      <div class="section">
            <h3>‚úÖ Ki·ªÉm th·ª≠</h3>
            <p><strong>K·ªãch b·∫£n:</strong> C√≥ m·ªôt ƒë∆°n ƒë·∫∑t ph√≤ng (ID=1) c√≥ ng√†y Check-out l√† ng√†y h√¥m qua, nh∆∞ng l·ªÖ t√¢n qu√™n check-out tr√™n ph·∫ßn m·ªÅm (Tr·∫°ng th√°i v·∫´n l√† <code>CONFIRMED</code>).</p>
            
            <p><strong>D·ªØ li·ªáu m·∫´u:</strong></p>
            <ul>
                  <li><code>DATPHONG</code>: ID=1, Status='CONFIRMED', Check-out='2025-04-03' (Gi·∫£ s·ª≠ hi·ªán t·∫°i l√† 2025-04-04)</li>
                  <li><code>PHONG</code>: ID=3 (P201), Status='OCCUPIED'</li>
            </ul>

            <p><strong>K·∫øt qu·∫£ mong ƒë·ª£i:</strong></p>
            <ul>
                  <li>ƒê∆°n ID=1 chuy·ªÉn th√†nh 'COMPLETED'</li>
                  <li>Ph√≤ng P201 chuy·ªÉn th√†nh 'AVAILABLE'</li>
            </ul>

            <pre><code>-- Ki·ªÉm tra tr∆∞·ªõc khi ch·∫°y
SELECT id, trang_thai FROM DATPHONG WHERE id = 1;
-- Ch·∫°y ƒëo·∫°n code Cursor b√™n tr√™n
-- Ki·ªÉm tra sau khi ch·∫°y
SELECT id, trang_thai FROM DATPHONG WHERE id = 1;</code></pre>

            <p><strong>K·∫øt qu·∫£:</strong> ƒê∆°n ID=1 chuy·ªÉn th√†nh 'COMPLETED'. Ph√≤ng P201 chuy·ªÉn th√†nh 'AVAILABLE'.</p>
      </div>
</body>

</html>